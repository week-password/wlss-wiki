[wiki](../../README.md) / [backend](index.md) /


# Задачи. Бэклог бэклога

Здесь будут просто заметки о том, что надо бы не забыть сделать. Сюда можно писать вещи, когда просто лень или есть определенные причины не создавать тикет.

***

- Добавить в README.md инструкцию по работе с зависимостями (poetry add ...) (poetry lock --no-update) (poetry lock --check) (устанавливать типы для майпая как поэтри зависимости вместо `mypy --install-types`) и всякие прочие штуки.

- Добавить описание проекта в репозитории проекта. Что такое вишер, что он позволяет делать и прочее. (можно сделать к моменту релиза MVP)

- заменить все относительные пути на абсолютные от рута проекта, см. [коммент](https://github.com/week-password/wisher-backend/pull/37#discussion_r1181081567)

- поправить опечатку в компоуз файлах "corrent file", и ещё множество других, например "This ugly" (нужно добавить "is"), "setup" во многих местах где должно быть "set up". И вообще внимательно посмотреть всё на предмет опечаток / ошибок

- добавить автоматизацию смены статуса тикета на "In review" при запросе ревью на пулл реквесте

- добавить поле closed_at в тикеты и автоматическое проставление этого поля при закрытии тикета, это позволит нам сделать сортировку по дате закрытия тикета на борде, чтобы последние тикеты отображались наверху а не внизу, хотя возможно стоит дождаться официального релиза этой фичи (см. [тут](https://github.com/orgs/community/discussions/8518) и [тут](https://github.com/github/roadmap/issues/659))

- добавить контекстные тикеты в коммит месседжи, например `(#40 > #21)` - пока не уверен, т.к. если мы в какой-то момент захотим автоматизировать создание коммит месседжей (см [обсуждение](https://github.com/week-password/wisher-backend/discussions/28)), то подход с контекстными тикетами может создать проблемы

- провести ресерч преимуществ и недостатков [pytest-describe](https://pypi.org/project/pytest-describe/) и [pytest-spec](https://pypi.org/project/pytest-spec/) и порефакторить тесты с использованием того или иного плагина

- придумать возможность удобной передачи списка файлов для линтинга в рафф и пайлинт, потому что каждый раз писать `pylitnt src tests` не очень удобно, а что самое главное можно в какой-то момент забыть указать папку которую необходимо проверить. Это поможет избежать ошибок типо [этой](https://github.com/week-password/wisher-backend/pull/20) **скорее всего ~~tox~~, ~~Invoke~~, bash решит эту проблему** Также это позволит убрать нам все конфигурационные файлы тулов в отдельную папку `tools/`, например `tools/flake8/config.ini`.

- рассмотреть использование make для запуска длинных docker compose команд на CI

- поресерчить решение проблем возникших при работе с pytest-alembic и описанных [здесь](https://github.com/week-password/wisher-backend/issues/29#issuecomment-1545976623)

- добавить возможность читать параметр конфигурации из pylintrc файла для [pylint-per-file-ignores](https://github.com/christopherpickering/pylint-per-file-ignores)

- отсортировать всё в компоуз файлах в алфавитном порядке

- заменить скрипт `envs/local/dev/scripts/git/iam.sh` на инструкцию в разделе "First time setup"

- рассмотреть возможность добавления [Rich](https://github.com/Textualize/rich#rich-library) для настройки [трейсбеков](https://rich.readthedocs.io/en/latest/traceback.html#) при разработке (огромные трейсы от асинхронного кода немного раздражают)

- обновить зависимости перед началом разработки функциональности MVP

- убрать разделители `***` вокруг раздела "System requirements" в README.md - кажется в них нет смысла ведь каждый заголовок и так отделен линией, а также первый разделитель в разделе "Troubleshooting", а также добавить пустую строку перед разделом "Working with migrations" и перед разделом "System requirements"

- после релиза MVP попытаться порефакторить код с помощью внедрения [DDD репозиториев](https://dddinpython.com/index.php/2022/11/09/implementing-the-repository-pattern-using-sqlalchemy/), решение принято в этом [мр](https://github.com/week-password/wisher-backend/pull/46#discussion_r1194064687)

- после релиза MVP попытаться порефакторить структуру папок в соответствии с обсуждением в [мр](https://github.com/week-password/wisher-backend/pull/46#discussion_r1193114213)

- написать checker для whitelist.txt файла, который будет репортить неиспользуемые слова

- написать плагин для флейка, который запрещал бы `else` и `elif`

- форкнуть flake8-import-order и дописать логику по сортировке импортов в TYPE_CHECKING блоке

- ~~перед началом разработки MVP функциональности и после настройки CD, сделать "Plug And Play" сборки для бэка и фронта~~ фронт сказал, что им это не нужно, на бэке скорее всего тоже пока обойдёмся

- поресерчить возможность использования более строгих типов определенных в [pydantic](https://docs.pydantic.dev/latest/usage/types/#pydantic-types)

- переименовать воркфлоу файлы в вид `<environment>-<goal>`, например: `deploy-to-test.yml` -> `test-deploy.yml`, `lint.yml` -> `ci-lint.yml` и тд (по аналогии со структурой папок внутри envs/)

- добавить [poetry-plugin-sort](https://pypi.org/project/poetry-plugin-sort/) для сортировки зависимостей (Но надо найти способ, чтобы не ставить его в глобальный скоуп, в котором по дефолту находится Poetry, возможно нужно использовать pipx)

- Зафиксировать версию поэтри в pyproject.toml, чтобы не перепесивалась первая строка в локфайле (Не уверен, что это правильный способ, т.к. он фризит только версию poetry-core, и возможно это не то, что нужно)

- оптимизировать конфигурацию поэтри для деплоя, добавить кэширование зависимостей, и посмотреть как кэшировать слои Dockerfile (особенно слой с apt-get update) (нужно просмотреть [список](https://python-poetry.org/docs/configuration/#available-settings) настроек и посмотреть какие из них лучше подходят для деплоя)

- ограничить возможность деплоя (пуш тэга) только для участников репозитория

- поресерчить возможности сокрытия апишки бэкенда для всех кроме фронта

- добавить в healthcheck эндпойнт проверку коннекшенов ко внешним сервисам типо постгреса и минио (задача вдохновлена [этим](https://microservices.io/patterns/observability/health-check-api.html))

- подумать куда можно вынести определения сваггера, чтобы не засорять файлы `routes.py` (см. [пр](https://github.com/week-password/wlss-backend/pull/75#discussion_r1236629728))

- подумать над добавлением тэга в название роутера, чтобы его было удобнее использовать, например: `APIRouter(tags="auth")` -> `AuthRouter(tags="auth")`, `APIRouter(tags="service")` -> `ServiceRouter(tags="service")`

- подумать над добавлением файла, который исключает коммиты из блейма, почитать об этом можно [тут](https://www.stefanjudis.com/today-i-learned/how-to-exclude-commits-from-git-blame/), [тут](https://git-scm.com/docs/git-blame#Documentation/git-blame.txt---ignore-revs-fileltfilegt) и [тут](https://docs.github.com/en/repositories/working-with-files/using-files/viewing-a-file#ignore-commits-in-the-blame-view)

- разобраться почему при использовании нашего кастомного декоратора @enum.types(), в IDE перестаёт работать автокомплит для членов этого енама

- добавить опцию validate_assignment в базовую модель src.shared.schemas.Schema

- подумать над удалением не имеющих смысла докстрингов

- поправить табуляцию в файле `.flake8`

- поправить наличие/отсутствие пустых строк в файле .ruff.toml (разделы начинающиеся с квадратных скобок должны быть разделены двумя пустыми строками), параметры внутри разделов - одной. Первая опция конфигурации в каждом разделе должна быть отделена от названия раздела одной пустой строкой.

- перепроверить, надо ли добавлять модель для примера респонза в список resposnes в роутах

- возможно стоит отказаться от pydantic SecretStr из за опасности возникающей при хешировании (хешироваться будет не сам пароль, а его представление в виде `"********"``)

- подумать над добавлением тестов, которые проверяли бы examples из сваггера на соответствие моделям (response_model например) - кажется это можно сделать если импортировать в тест само определение роута и через атрибуты достать экземплы, модели и сматчить их

- подумать над возможностью создания универсальных классов полей, т.е. чтобы, например fields.Email выполнял валидацию не только находясь в схеме пайдентика, но и сам по себе, например при вызове fields.Email("john_doe@mail.com") - кажется, этого можнод добиться если вызывать `__get_validators__` в `__init__` - Кажется эта функциональность и так уже работает (перепроверить)

- использовать переменную окружения $BUILDX_CACHE_SRC в экшене .github/actions/use-buildx-cache/action.yml вместо захардкоженного пути - кажется это не так-то просто сделать, а скорее всего невозможно. Один из вариантов это прокинуть её через переменные окружения в Github Actions, но это по сути то же самое дублирование, поэтому смысла нет

- кажется flake8-aaa не отдаёт ошибку, если в тесте нет `result = `, надо перепроверить и поправить - flake8-aaa текущей версии не работает с асинхронными тестами (async def) - возможно обновление версии flake8-aaa решит проблему - обновление с 0.14.0 до 0.16.0 не решило проблему

- переименовать скрипт `rebased_branch.py` в `forcepushed_branch.py`

- почему не работает блейм в вскоде?

- убрать строчки `fetch-depth: 0` из `.github/workflows/cleanup-yml`, т.к. мы больше не используем локальный гит для получения информации о ветках/коммитах, вместо этого мы используем API гитхаба через либу `pygithub`.

- не понятно кэширует ли cleanup воркфлоу pip зависимости - перепроверить и поправить при необходимости

- заменить захардкоженное имя дефолтной ветки в `envs/ci/lint/scripts/github/cleanup/runs/rebased_branch.py

- добавить проверку `github.ref_type == 'branch'` в ограничение запуска джобы очищения ребейзнутой ветки

- передавать значения в композитные экшены через inputs вместо переменных окружения, т.к. inputs позволяет добавить описание через поле description, а также сделать инпут обязательным через поле required. Это

- убрать волюмы постгреса и minio для тестов на ci (сделать анонимными)

- убрать session.commit() из set_autoincrement_counters() т.к. судя по всему session.execute() коммитит сам

- кажется set_autoincrement_counters содержит уязвимость для sql-инъекции, т.к. там для формирования запроса используется f-строка

- подумать над добавлением pytest-deadfixtures (https://pypi.org/project/pytest-deadfixtures/)

- использовать @property в конфиге, чтобы задать композитные значения (по аналогии с acih-backend)

- вынести применение миграций алембика в отдельный step на CI, чтобы очистить логи команд `pytest --cov=src` и `alembic --check`

- добавить поле login в схему с данными аккаунта во все эндпойнты где она используется (уточнить у fowesn зачем)

- добавить инфу о том как найти логи стенда в Environments в приватный репозиторий

- добавить плагин флейка на комплексити

- как оказалось bcrypt хэширует только пароли длиной не более 72 символов (см [доку](https://pypi.org/project/bcrypt/)). Если длина больше то остаток он просто отбрасывает. Разобраться с этим как нибудь

- убрать лишние заглавные буквы в описаниях сваггера у ддд слов - без больших букв тоже норм и не надо мучаться их проставлять

- отрефакторить содержимое папки src/shared - сейчас например классы эксепшенов, схемы эксепшенов и сваггер для эксепшенов определены в трёх разных файлах - хорошо было бы скомпоновать их по принципу package-by-feature внутри папки src/shared

- рассмотреть возможность использования более строгих типов пайдентика для определения моделей алхимии, например заменить `id: Mapped[int]` на `id: Mapped[PositiveInt]`

- подумать над тем как коннектиться к бд на qa стенде через dbeaver - на данный момент 5432 порт закрыт в докере (возможно и на стенде) и снаружи в него не достучаться

- поресерчить возможности фреймворка [lightstart](https://github.com/litestar-org/litestar), возможно он окажется хорошей заменой фастапи или хотя бы подойдёт для bff

- убрать неиспользуемые created_at поля из респонз-экземплов

- исправить "or" -> "and" в тексте ошибок полей (src/shared/fields.py), например
    ```python
        if not hasattr(cls, "LENGTH_MIN") or not hasattr(cls, "LENGTH_MAX"):
            msg = "LENGTH_MIN or LENGTH_MAX should be defined in a subclass."
            #                 ^^ заменить на "and"
    ```

- добавить команды очистки в qa-deploy пайплайн - очиста имейджей, контейнеров, волюмов (в отдельном воркфлоу, см [ссылку](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#running-a-workflow-based-on-the-conclusion-of-another-workflow)):
```bash
docker container prune --all --force
docker image prune --all --force
docker volume prune --all --force
docker builder prune --force
```

- использовать multistage-build возможности в docker compose (репа фронта) - судя по всему, кажется достаточно просто добавить target: nginx в секцию build

- поправить имена контейнеров и компоузов в репе фронта, т.к. там какой-то хаос. Необходимо привести всё в порядок и сделать так же как в be репе

- поправить существующие ForeignKey - добавить ondelete и onupdate = "restrict" а также попытаться указать колонку модели вместо строки ("account.id" -> Account.id)

- удалить депенденси get_minio - в его использовании нет смысла. Его имеет смысл использовать для бд, т.к. мы хотим иметь возможность переопределять бд сессию в тестах, но для минио мы переопределяем коннекшн более простым способом - через конекшн параметры в конфиге.

- правки консистентности - в эндпойнте регистрации заменить request_data на new_user (в контроллере), заменить Depends в дефолтных аргументах на Depends через Annotated тип

- использовать dirty_equals с кастомными типами в тестах для проверки динамических значений (id, uuid, datetime) - т.к. freezegun не работает с эндпойнтами с минио - минио не может обработать запрос т.к. "время реквеста, слишком сильно отличается от текущего" - о боже, что за капризы

- после того как будет создано больше тестов, можно будет поправить их производительность с помощью pytest-describe - на данный момент узкое место это работа с minio (загрузка/скачивание файлов занимают больше всего времени), при этом для одного эндпойнта у нас может несколько тестов - для тестирования респонза, сайд эффектов и внешних вызовов. Т.е. одно и то же действие minio будет выполняться три раза. Это можно исправить через pytest-describe следующим образом: мы будем вызывать SUT один раз, и делать проверки трёх типов в разных блоках, таким образом мы всё ещё будем иметь визуальное разделение этих типов проверок и при этом вызывать SUT всего один раз.

- Дополнить статью про авторизацию информацией о том как использовать JWT чтобы это было stateless (добавить device_id в пейлоад, и хранить в бд только device_id), а также описать проблему генерации неуникальных JWT если мы используем JWT в качестве уникальных идентификаторов

- Перенести эндпойнт создания аккаунта и соответствущие схемы из пакета `auth` в пакет `account`

- убрать user_id из пути в эндпойнте входа (sign in), т.к. на данный момент фронт ещё не знает user_id и не может его подставить (юзер-то не залогинен)

- добавить описания существующих тегов в app.py (в `openapi_tags=`)

- убрать поля created_at и updated_at из всех респонзов (и схем) во всех эндпойнтах, т.к. на данный момент фронту они не нужны, а также перепровить наличие других неиспользуемых полей в реквестах и респонзах, и убрать их (например поле avatar_id в реквесте на регистрацию аккаунта)

- поправить GET эндпойнты с Json телом (на данный момент это эндпойнты на матч айдишников и логинов в `auth`)

- подумать над использованием стандартизованных JWT claims в пейлоаде токена

- добавить определение входных данных в эндпойнт reject_firendship_request

- по возможности избавиться от использования `**`, т.к. это скрывает использование аргументов и невозможно отследить использование аргумента, который скрыт за `**` - можно оставить ** только для аргументов которые никак не используются внутри нашего кода

- добавить обработчик неизвестных ошибок, который будет просто писать трейсбек в лог и возвращать 500 клиенту (перед этим необходимо проверить, возможно фастапи уже так работает из коробки)

- # TODO: should we change `friendship`` -> `friendships`` ?  - yes but as a part of friendship endpoints reworking due to BFF creation

- поправить responses: {status.HTTP_200_OK: ...} на responses: {status.HTTP_201_CREATED: ...} в роуте create_file

- убрать заменить "COPY . ./" в докерфайлах на более селективную команду (Проблема текущей команды в том, что она может скопировать в имейдж какой-нибудь мусор вроде .venv или .mypy_cache)
